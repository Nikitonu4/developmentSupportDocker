# Среда для поддержки процесса разработки ПО: Jenkins+Gitea+Kanboard
---
## Общая структура docker-compose.yml:
- Приложения объединены одной сетью под названием ```devops```
### Сервисы:
- ```jenkins``` - система непрерывной интеграции
- ```gitea``` - система управления репозиториями на базе Git
- ```db``` - база данных ```mysql``` для Gitea
- ```kanboard``` - система управления задачами
---
## Описание каждого сервиса:
1) ```jenkins, версия 2.289.1-lts-jdk11```
- Том ```/var/jenkins_home``` используется для хранения данных приложения
- Веб интерфейс работает на ```8080``` порту, а  ```50000``` порт используется для доступа к удаленному Java API
2) ```gitea, версия 1.14.3```
- Том ```/data``` используется для хранения данных приложения
- Тома ```/etc/timezone:ro``` и ```/etc/localtime:ro``` используются для синхронизации времени и часового пояса хоста
- Веб интерфейс работает на ```3000``` порту, а ```2222``` порт используется для ssh соединений(например, для клонирования репозитория)
- Сервис зависим от сервиса ```db```, на котором расположена его база данных
3) ```db, MySQL 8 версии```
- Том ```/var/lib/mysql``` используется для хранения базы данных
- Данная база данных работает на ```3306``` порту
4) ```kanboard, версия 1.2.20```
- Том ```/var/www/app/data``` используется для хранения данных приложения
- Том ```/var/www/app/plugins``` используется для хранения установленных плагинов
- Том ```/etc/nginx/ssl``` используется для хранения ssl ключей
- Веб интерфейс работает на ```80``` порту, а  ```443``` порт используется для защищенных соединений с ssl
---
## Запуск
1) Перед первым запуском необходимо прописать переменные окружения в файле ```.env```:
- ```USER_UID=1000``` - UID юзера
- ```USER_GID=1000``` - UID группы
- ```DB_NAME_FOR_GITEA=gitea``` - название базы данных MySQL
- ```DB_USER_FOR_GITEA=gitea``` - имя юзера бд
- ```DB_PASSWD_FOR_GITEA=gitea``` - пароль для бд
- ```DB_ROOT_PASSWD_FOR_GITEA=gitea``` - пароль админа бд
- ```domain=http://192.168.1.80``` - хост.
2) После изменения файла ```.env``` необходимо ввести команду ```docker-compose up```. После этого все сервисы будут доступны на своих портах. 
---
## Создание резервных копий
- ВНИМАНИЕ: перед всеми действиями с данными контейнеры необходимо отключить! Для отключение контейнеров(если они запущены в фоновом режиме) необходимо выполнить команду ```docker-compose down```.
- Скрипт ```backup.py``` находится в папке ```backup```
- Для запуска нужен установленный ```python3```
- Т.к все данные находятся в папке data в корне проекта, то для резервного копирования достаточно написать ```python3 backup.py zip```. После этого действия в папке ```backup``` создастся архив в формате ```dataBackup d-m-Y H:M.zip```
- Для восстановления данных необходимо запустить скрипт ```python3 backup.py unzip path_to_archive```, где ```path_to_archive``` - путь к архиву с данными. После этого действия удалится папка ```data``` в корне проекта(если она есть), архив разархивируется и данные будут восстановлены в новую папку ```data```.
